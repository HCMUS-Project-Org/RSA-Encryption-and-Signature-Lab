#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <openssl/bn.h>

void printBN(char *msg, BIGNUM *a)
{
	// Convert the BIGNUM to number string
	char *number_str = BN_bn2hex(a);
	// Print out the number string
	printf("%s %s\n", msg, number_str);
	// Free the dynamically allocated memory
	OPENSSL_free(number_str);
}

int Task6_VerifySignature(BIGNUM *n, BIGNUM *e, BIGNUM *S, BIGNUM *hash)
{
	BN_CTX *ctx = BN_CTX_new();

	// h2 is h'
	BIGNUM *h2 = BN_new();

	// h' = S^e mod n
	BN_mod_exp(h2, S, e, n, ctx);

	// calc h = string2hex(M)
	//char *h1 = string2hexString(M, strlen(M));

	printBN("> H value:", hash);
	printBN("> H' value:", h2);

	// return compare of h and h'
	if (strstr(BN_bn2hex(h2), BN_bn2hex(hash)) != NULL)
	{
		return 0;
	}
	else return 1;
}


int main()
{
	BIGNUM *n = BN_new();
	BIGNUM *e = BN_new();
	BIGNUM *s = BN_new();
	BIGNUM *hash = BN_new();

	BN_hex2bn(&n, "C24E1667DDCEBC6AC8375AEC3A30B01DE6D112E8122848CCE829C1B96E53D5A3EB03391ACC7787F601B9D970CCCF6B8DE3E3037186996DCBA6942A4E13D6A7BD04EC0A163C0AEB39B1C4B558A3B6C75625EC3E527AA8E3291607B96E50CFFB5F31F81DBA034A628903AE3E47F20F2791E3142085F8FAE98A35F55F9E994DE76B37EFA4503E44ECFA5A8566079C7E176A55F3178A351EEEE9ACC3754E58557D536B0A6B9B1442D7E5AC0189B3EAA3FECFC02B0C84C2D85315CB67F0D088CA3AD11773F55F9AD4C5721E7E01F19830632AAAF27A2DC5E2021A86E5323E0EBD11B4CF3C93EF1750109E43C2062AE00D68BED3888B4A658C4AD4C32E4C9B55F486E5");
	BN_hex2bn(&e, "10001");
	BN_hex2bn(&s, "9580D7F82AD15A90F9B1A2347BB284BBFF1E968BED8DFFD1C66CCEDF8F0BEFCA0F47C0C4527C0B8BF7ED1C409DC8EC3DD1FDD85C00D6AFF31BB7E1F48EC09EB77A61E8F2508E94ED90AD0D919C3C4752494CDEB0EF1ABC3BBFA254A1C1BEB1FFFAB1DA5CD73CF9E78A67077A95470DE930F886EF842CA126FAAF892812D45838A4DE0F959214638E7171578933700BC913F64409B96BC3D305B5A683BF9F179F411746169A54679D4F67FA2A177AB102DA33F49BD296FA4F1AA47AFE47617112B4EB608505B32E8B79E81B7AA697867C0CA29160E42240D33A055D364319354F27285F55075ECECAC261F24DB3B871BB8AFAD9978F67D87DB0E8C3C6ACF092D1");
	BN_hex2bn(&hash, "4A8F4EB394CEC0C47F8D9FF64B1341D7A870EA1C660524017433629BE2F32171");

	if (Task6_VerifySignature(n, e, s, hash) == 0)
		printf("\n>> This signature is validate\n");
	else
		printf("\n>> This signature is NOT validate\n");

	return 0;
}